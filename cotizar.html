<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cotizar - LEVER</title>
    <link rel="stylesheet" href="cotizar.css?v=1.2" />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <header>
      <div class="container header-container">
        <div itemprop="logo" class="logo-container">
          <a href="#"
            ><img src="./images/logos/lever.svg" alt="Lever Technology"
          /></a>
        </div>
        <div class="hamburguer-menu" onclick="toggleMenu()">
          <div class="bar"></div>
          <div class="bar"></div>
          <div class="bar"></div>
        </div>
      </div>
      <nav
        id="menu"
        itemprop="mainEntityOfPage"
        itemscope
        itemtype="http://schema.org/SiteNavigationElement"
        class="hidden"
      >
        <ul>
          <li>
            <a
              href="index.html"
              itemprop="url"
              class="scroller outline"
              data-text="Inicio"
              data-url="#inicio"
              ><span itemprop="name">Inicio</span></a
            >
          </li>
          <li>
            <a
              href="index.html#nosotros"
              itemprop="url"
              class="scroller outline"
              data-text="Nosotros"
              data-url="#nosotros"
              ><span itemprop="name">Nosotros</span></a
            >
          </li>
          <li>
            <a
              href="index.html#contacto"
              itemprop="url"
              class="scroller outline"
              data-text="Contacto"
              data-url="#contacto"
              ><span itemprop="name">Contacto</span></a
            >
          </li>
          <li>
            <a
              href="cotizar.html"
              itemprop="url"
              class="scroller outline"
              data-text="Cotizar"
              data-url="#cotizar"
              ><span itemprop="name">Cotizar</span></a
            >
          </li>
        </ul>
      </nav>
    </header>
    <main>
      <section id="cotizar">
        <div class="container">
          <!-- Paso 1 -->
          <div id="step-1" class="step active">
            <h2>Cotizador online</h2>
            <h1>PASO <strong>1 DE 3</strong></h1>
            <div class="switch-container">
              <span class="switch-label-left" onclick="toggleSwitch(false)"
                >CUIT</span
              >
              <label class="toggle-switch">
                <input type="checkbox" />
                <span class="switch-slider"></span>
              </label>
              <span class="switch-label-right" onclick="toggleSwitch(true)"
                >DNI</span
              >
            </div>
            <div class="dni-container">
              <input
                type="text"
                class="dni-input"
                placeholder="DNI del solicitante"
              />
              <div class="search-icon-container" onclick="showDropdown()">
                <img
                  src="./images/icons/search.svg"
                  alt="search icon"
                  class="search-icon"
                />
              </div>
              <div class="dropdown-content hidden">
                <div class="profile-header">
                  <img
                    src="./images/icons/user.svg"
                    alt="Icono de perfil"
                    class="profile-icon"
                  />
                  <h3 class="profile-name">Juan Gonzalez</h3>
                </div>
                <div class="inner-box">
                  <h3 class="inner-box-title">
                    Posibilidad de gestión del crédito
                  </h3>
                  <div class="credit-viability-bar">
                    <div class="credit-indicator"></div>
                  </div>
                  <h4 class="credit-status-title">VIABLE</h4>
                  <p class="credit-status-subtitle">
                    Es posible que el crédito se apruebe
                  </p>
                </div>
                <button
                  class="change-applicant-button"
                  onclick="hideDropdown()"
                >
                  <span>Cambiar solicitante</span>
                </button>
              </div>
            </div>
            <div class="confidentiality-text">
              Los datos solicitados son confidenciales y no se van a almacenar
              en ninguna base de datos.<br /><br />Al avanzar, el usuario acepta
              los <strong>Términos y Condiciones de Servicio.</strong>
            </div>
            <div class="navigation-buttons">
              <button class="back-button hidden" onclick="goToStep(1)"></button>
              <button class="next-button" onclick="goToStep(2)">
                <span class="next-text">Siguiente</span>
                <img
                  src="./images/icons/flecha.svg"
                  alt="flecha"
                  class="next-arrow"
                />
              </button>
            </div>
          </div>

          <!-- Paso 2 -->
          <div id="step-2" class="step hidden">
            <h2>Cotizador online</h2>
            <h1>PASO <strong>2 DE 3</strong></h1>
            <div class="options-container">
              <!-- Nuevo contenedor de opciones para Categoría -->
              <div class="custom-options-container">
                <div
                  class="custom-options-placeholder"
                  onclick="toggleCustomOptions('categoria-options')"
                >
                  Categoría
                </div>
                <div class="custom-options-extra hidden"></div>
                <!-- Nuevo div -->
                <div id="categoria-options" class="custom-options hidden">
                  <div
                    class="custom-option"
                    onclick="selectCustomOption('Autos y Pickups', 'categoria-options')"
                  >
                    <img
                      src="./images/icons/auto.svg"
                      alt="Autos y Pickups"
                      class="option-icon"
                    />
                    Autos y Pickups
                  </div>
                  <div
                    class="custom-option"
                    onclick="selectCustomOption('Motos', 'categoria-options')"
                  >
                    <img
                      src="./images/icons/moto.svg"
                      alt="Motos"
                      class="option-icon"
                    />
                    Motos
                  </div>
                  <div
                    class="custom-option"
                    onclick="selectCustomOption('Utilitarios', 'categoria-options')"
                  >
                    <img
                      src="./images/icons/pickup1.svg"
                      alt="Utilitarios"
                      class="option-icon"
                    />
                    Utilitarios
                  </div>
                </div>
              </div>

              <!-- Nuevo contenedor de opciones para Año -->
              <div class="custom-options-container">
                <div
                  class="custom-options-placeholder"
                  onclick="toggleCustomOptions('anio-options')"
                >
                  Año
                </div>
                <div class="custom-options-extra hidden"></div>
                <!-- Nuevo div -->
                <div id="anio-options" class="custom-options hidden">
                  <div
                    class="custom-option"
                    onclick="selectCustomOption('2023', 'anio-options')"
                  >
                    2023
                  </div>
                  <div
                    class="custom-option"
                    onclick="selectCustomOption('2022', 'anio-options')"
                  >
                    2022
                  </div>
                  <div
                    class="custom-option"
                    onclick="selectCustomOption('2021', 'anio-options')"
                  >
                    2021
                  </div>
                  <div
                    class="custom-option"
                    onclick="selectCustomOption('2021', 'anio-options')"
                  >
                    2020
                  </div>
                  <div
                    class="custom-option"
                    onclick="selectCustomOption('2021', 'anio-options')"
                  >
                    2019
                  </div>
                  <div
                    class="custom-option"
                    onclick="selectCustomOption('2021', 'anio-options')"
                  >
                    2018
                  </div>
                  <div
                    class="custom-option"
                    onclick="selectCustomOption('2021', 'anio-options')"
                  >
                    2017
                  </div>
                  <div
                    class="custom-option"
                    onclick="selectCustomOption('2021', 'anio-options')"
                  >
                    2016
                  </div>
                  <div
                    class="custom-option"
                    onclick="selectCustomOption('2021', 'anio-options')"
                  >
                    2015
                  </div>
                  <div
                    class="custom-option"
                    onclick="selectCustomOption('2021', 'anio-options')"
                  >
                    2014
                  </div>
                  <div
                    class="custom-option"
                    onclick="selectCustomOption('2021', 'anio-options')"
                  >
                    2013
                  </div>
                  <div
                    class="custom-option"
                    onclick="selectCustomOption('2021', 'anio-options')"
                  >
                    2012
                  </div>
                </div>
              </div>

              <!-- Nuevo contenedor de opciones para Marca -->
              <div class="custom-options-container">
                <div
                  class="custom-options-placeholder"
                  onclick="toggleCustomOptions('marca-options')"
                >
                  Marca
                </div>
                <div class="custom-options-extra hidden"></div>
                <!-- Nuevo div -->
                <div id="marca-options" class="custom-options hidden">
                  <div class="custom-search-container hidden">
                    <!-- Nuevo buscador -->
                    <img src="./images/icons/lupita.svg" alt="Buscar" />
                    <input
                      type="text"
                      placeholder="Buscar marca..."
                      oninput="filterOptions('marca-options', this.value)"
                    />
                  </div>
                </div>
              </div>

              <!-- Nuevo contenedor de opciones para Modelo -->
              <div class="custom-options-container">
                <div
                  class="custom-options-placeholder"
                  onclick="toggleCustomOptions('modelo-options')"
                >
                  Modelo
                </div>
                <div class="custom-options-extra hidden"></div>
                <!-- Nuevo div -->
                <div id="modelo-options" class="custom-options hidden">
                  <div class="custom-search-container hidden">
                    <!-- Nuevo buscador -->
                    <img src="./images/icons/lupita.svg" alt="Buscar" />
                    <input
                      type="text"
                      placeholder="Buscar modelo..."
                      oninput="filterOptions('modelo-options', this.value)"
                    />
                  </div>
                </div>
              </div>
            </div>
            <div class="navigation-buttons">
              <button class="back-button" onclick="goToStep(1)">
                <img
                  src="./images/icons/FlechaNegra.svg"
                  alt="flecha"
                  class="next-arrow"
                />
              </button>
              <button class="next-button" onclick="goToStep(3)">
                <span class="next-text">Siguiente</span>
                <img
                  src="./images/icons/flecha.svg"
                  alt="flecha"
                  class="next-arrow"
                />
              </button>
            </div>
          </div>

          <!-- Paso 3 -->
          <div id="step-3" class="step hidden">
            <h2>Cotizador online</h2>
            <h1>PASO <strong>3 DE 3</strong></h1>
            <div class="container-step3">
              <div class="vehicle-summary">
                <img id="vehicle-logo" src="" alt="Logo de la marca" />
                <div class="vehicle-details">
                  <h3 id="vehicle-brand">Marca</h3>
                  <p id="vehicle-model">Modelo</p>
                  <p id="vehicle-year">Año</p>
                </div>
              </div>
              <!-- Select de productos con clase específica -->
              <div
                id="product-select-container"
                class="custom-options-container product-select"
              >
                <div
                  class="custom-options-placeholder"
                  onclick="toggleCustomOptions('product-options')"
                >
                  Seleccionar Producto
                </div>
                <div class="custom-options-extra hidden"></div>
                <div id="product-options" class="custom-options hidden">
                  <!-- Opciones dinámicas o estáticas -->
                  <div
                    class="custom-option"
                    onclick="selectCustomOption('Producto 1', 'product-options')"
                  >
                    Producto 1
                  </div>
                  <div
                    class="custom-option"
                    onclick="selectCustomOption('Producto 2', 'product-options')"
                  >
                    Producto 2
                  </div>
                  <div
                    class="custom-option"
                    onclick="selectCustomOption('Producto 3', 'product-options')"
                  >
                    Producto 3
                  </div>
                </div>
              </div>
              <!-- Nuevo div debajo del select de productos -->
              <div class="custom-summary">
                <h3 class="custom-summary-title">Máximo a financiar</h3>
                <span class="custom-summary-currency">$</span>
                <span class="custom-summary-amount">18.564.220</span>
              </div>
              <div class="custom-summary-input">
                <input
                  type="text"
                  class="net-finance-input"
                  placeholder="Monto neto a financiar"
                />
              <p class="min-amount-text">Monto mínimo: $1.000.000</p> </div>
            </div>
            <div class="navigation-buttons">
              <button class="back-button" onclick="goToStep(1)">
                <img
                  src="./images/icons/FlechaNegra.svg"
                  alt="flecha"
                  class="next-arrow"
                />
              </button>
              <button class="next-button" onclick="goToStep(4)">
                <span class="next-text">Siguiente</span>
                <img
                  src="./images/icons/flecha.svg"
                  alt="flecha"
                  class="next-arrow"
                />
              </button>
            </div>
          </div>

          <!-- Paso 4 - Nueva pantalla para cotización estimada -->
          <div id="step-4" class="step hidden">
            <h2>Cotizador online</h2>
            <h1>
              <span style="font-size: 24px; font-family: Montserrat; font-weight: bold; color: #2ADC9F; ">COTIZACIÓN</span>
              <span style="font-size: 24px; font-family: Montserrat; font-weight: 300; color: #2ADC9F; letter-spacing: -3px;">ESTIMADA</span>
            </h1>
            
            <div class="navigation-buttons">
              <button class="back-button" onclick="goToStep(3)">
                <img src="./images/icons/FlechaNegra.svg" alt="flecha" class="next-arrow" />
              </button>
              <button class="next-button" onclick="finalizeCotizacion()">
                <span class="next-text">Finalizar</span>
                <img src="./images/icons/flecha.svg" alt="flecha" class="next-arrow" />
              </button>
            </div>
          </div>
        </div>
      </section>
    </main>
    <footer class="footer">
      <button class="inicio-button">
        <img
          src="./images/icons/inicio1.svg"
          alt="inicio icon"
          class="inicio-icon"
        />
        <span class="inicio-text">Inicio</span>
      </button>
    </footer>

    <script>
      function toggleMenu() {
        const menu = document.getElementById("menu");
        menu.classList.toggle("hidden");
      }

      function toggleSwitch(isChecked) {
        const checkbox = document.querySelector(".toggle-switch input");
        checkbox.checked = isChecked;
        updateSwitchLabels();
      }

      function updateSwitchLabels() {
        const leftLabel = document.querySelector(".switch-label-left");
        const rightLabel = document.querySelector(".switch-label-right");
        const checkbox = document.querySelector(".toggle-switch input");
        const dniInput = document.querySelector(".dni-input");
        if (checkbox.checked) {
          leftLabel.style.color = "#303047";
          rightLabel.style.color = "#FFFFFF";
          dniInput.placeholder = "DNI del solicitante";
        } else {
          leftLabel.style.color = "#FFFFFF";
          rightLabel.style.color = "#303047";
          dniInput.placeholder = "CUIT del solicitante";
        }
      }

      document
        .querySelector(".toggle-switch input")
        .addEventListener("change", updateSwitchLabels);
      updateSwitchLabels();

      function showDropdown() {
        const dniContainer = document.querySelector(".dni-container");
        const dropdownContent = document.querySelector(".dropdown-content");
        const searchIcon = document.querySelector(".search-icon-container");

        dniContainer.classList.add("expanded");
        dropdownContent.classList.remove("hidden");
        searchIcon.style.display = "none";
      }

      function hideDropdown() {
        const dniContainer = document.querySelector(".dni-container");
        const dropdownContent = document.querySelector(".dropdown-content");
        const searchIcon = document.querySelector(".search-icon-container");

        dniContainer.classList.remove("expanded");
        dropdownContent.classList.add("hidden");
        searchIcon.style.display = "flex";
      }

      function goToStep(step) {
        const steps = document.querySelectorAll(".step");
        steps.forEach((stepElement, index) => {
          if (index + 1 === step) {
            stepElement.classList.remove("hidden");
            stepElement.classList.add("active");
          } else {
            stepElement.classList.add("hidden");
            stepElement.classList.remove("active");
          }
        });
      }

      function finalizeCotizacion() {
        alert("Gracias por usar nuestro cotizador.");
        // Aquí puedes agregar lógica adicional para finalizar el proceso.
      }
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        document
          .querySelectorAll(".custom-options-container")
          .forEach((container, index, containers) => {
            const placeholder = container.querySelector(
              ".custom-options-placeholder"
            );
            const options = container.querySelector(".custom-options");
            const extraDiv = container.querySelector(".custom-options-extra"); // Nuevo div
            const searchContainer = options.querySelector(
              ".custom-search-container"
            ); // Nuevo buscador
            const searchInput = searchContainer
              ? searchContainer.querySelector("input")
              : null; // Input del buscador

            // Función para ajustar el margen del siguiente select
            const adjustNextSelect = (isExpanded) => {
              containers.forEach((cont, i) => {
                if (i === index + 1) {
                  cont.style.marginTop = isExpanded ? "197px" : "15px"; // Ajustar margen solo para el siguiente select
                } else {
                  cont.style.marginTop = "15px"; // Los demás no tienen margen adicional
                }
              });
            };

            // Abrir o cerrar las opciones al hacer clic en el placeholder
            placeholder.addEventListener("click", (event) => {
              event.stopPropagation(); // Evitar que el evento se propague
              const allOptions = document.querySelectorAll(".custom-options");
              const allPlaceholders = document.querySelectorAll(
                ".custom-options-placeholder"
              );
              const allExtras = document.querySelectorAll(
                ".custom-options-extra"
              ); // Todos los extras
              const allSearchContainers = document.querySelectorAll(
                ".custom-search-container"
              ); // Todos los buscadores

              // Cerrar todos los selects abiertos excepto el actual
              allOptions.forEach((opt) => {
                if (opt !== options) {
                  opt.classList.add("hidden");
                }
              });

              allPlaceholders.forEach((ph) => {
                if (ph !== placeholder) {
                  ph.classList.remove("active"); // Quitar clase para rotar la flecha
                }
              });

              allExtras.forEach((extra) => {
                if (extra !== extraDiv) {
                  extra.classList.remove("active"); // Ocultar extras no relacionados
                }
              });

              allSearchContainers.forEach((search) => {
                if (search !== searchContainer) {
                  search.classList.remove("active"); // Ocultar buscadores no relacionados
                }
              });

              // Alternar el estado del select actual, su extra y el buscador
              if (options.classList.contains("hidden")) {
                options.classList.remove("hidden");
                placeholder.classList.add("active"); // Agregar clase para rotar la flecha
                extraDiv.classList.add("active"); // Mostrar el extra
                if (searchContainer) searchContainer.classList.add("active"); // Mostrar el buscador
                adjustNextSelect(true); // Ajustar margen del siguiente select
              } else {
                options.classList.add("hidden");
                placeholder.classList.remove("active"); // Quitar clase para rotar la flecha
                extraDiv.classList.remove("active"); // Ocultar el extra
                if (searchContainer) searchContainer.classList.remove("active"); // Ocultar el buscador
                adjustNextSelect(false); // Volver a la posición original
              }
            });

            // Evitar que el buscador cierre o mueva los selects al hacer clic
            if (searchContainer) {
              searchContainer.addEventListener("click", (event) => {
                event.stopPropagation(); // Evitar que el evento cierre el select
              });

              // Filtrar opciones en tiempo real
              searchInput.addEventListener("input", (event) => {
                const filterText = event.target.value.toLowerCase();
                const allOptions = options.querySelectorAll(".custom-option");
                allOptions.forEach((option) => {
                  const optionText = option.textContent.toLowerCase();
                  if (optionText.includes(filterText)) {
                    option.style.display = "flex"; // Mostrar opción si coincide
                  } else {
                    option.style.display = "none"; // Ocultar opción si no coincide
                  }
                });
              });
            }

            // Seleccionar una opción
            options.addEventListener("click", (event) => {
              if (event.target.classList.contains("custom-option")) {
                placeholder.textContent = event.target.textContent; // Actualizar el texto del placeholder
                placeholder.dataset.value = event.target.textContent; // Guardar el valor seleccionado
                options.classList.add("hidden"); // Cerrar el menú desplegable
                placeholder.classList.remove("active"); // Quitar clase para rotar la flecha
                extraDiv.classList.remove("active"); // Ocultar el extra
                if (searchContainer) {
                  searchContainer.classList.remove("active"); // Ocultar el buscador
                  searchInput.value = ""; // Limpiar el texto del buscador
                  const allOptions = options.querySelectorAll(".custom-option");
                  allOptions.forEach((option) => {
                    option.style.display = "flex"; // Mostrar todas las opciones
                  });
                }
                adjustNextSelect(false); // Volver a la posición original
              }
            });

            // Cerrar las opciones si se hace clic fuera del contenedor
            document.addEventListener("click", (event) => {
              document
                .querySelectorAll(".custom-options-container")
                .forEach((container) => {
                  const options = container.querySelector(".custom-options");
                  const placeholder = container.querySelector(
                    ".custom-options-placeholder"
                  );
                  const extraDiv = container.querySelector(
                    ".custom-options-extra"
                  );
                  const searchContainer = options.querySelector(
                    ".custom-search-container"
                  );
                  if (!container.contains(event.target)) {
                    options.classList.add("hidden");
                    placeholder.classList.remove("active"); // Quitar clase para rotar la flecha
                    extraDiv.classList.remove("active"); // Ocultar el extra
                    if (searchContainer)
                      searchContainer.classList.remove("active"); // Ocultar el buscador
                    container.style.marginTop = "15px"; // Resetear margen
                  }
                });
            });
          });
      });

      document.addEventListener("DOMContentLoaded", () => {
        let dataWithLogo = []; // Array para almacenar marcas y sus logos

        const fetchMarcasFromInfoauto = async (year) => {
          try {
            const requestBody = {
              year: year.trim(),
              accessToken: null,
              action: "getBrandsByYear",
            };

            const response = await fetch("php/curl.php", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(requestBody),
            });

            if (!response.ok) {
              throw new Error(
                `Error al obtener marcas: ${response.status} ${response.statusText}`
              );
            }

            const data = await response.json();
            const marcasSelect = document.getElementById("marca-options");
            dataWithLogo = data.brands; // Guardar datos de marcas con logos

            // Guardar el buscador existente antes de limpiar el contenedor
            let searchContainer = marcasSelect.querySelector(
              ".custom-search-container"
            );
            if (!searchContainer) {
              searchContainer = document.createElement("div");
              searchContainer.className = "custom-search-container active";
              searchContainer.innerHTML = `

                        <img src="./images/icons/lupita.svg" alt="Buscar" />
                        <input type="text" placeholder="Buscar marca..." oninput="filterOptions('marca-options', this.value)" />
                    `;
              marcasSelect.prepend(searchContainer);
            }

            marcasSelect.innerHTML = ""; // Limpiar opciones existentes
            // Reinsertar el buscador existente
            if (searchContainer) {
              marcasSelect.appendChild(searchContainer);
              searchContainer.classList.remove("hidden"); // Asegurar que esté visible
            }

            data.brands.forEach((brand) => {
              const option = document.createElement("div");
              option.className = "custom-option";
              option.textContent = brand.name;
              option.dataset.value = brand.id;
              option.dataset.logo = brand.logo; // Guardar la URL del logo
              option.onclick = () =>
                selectCustomOption(brand.name, "marca-options", brand.id);
              marcasSelect.appendChild(option);
            });

            console.log("Marcas obtenidas:", data.brands);
          } catch (error) {
            console.error("Error al obtener marcas desde Infoauto:", error);
          }
        };

        const getLogo = (id) => {
          const element = dataWithLogo.find((element) => element.id == id);
          const logoUrl = element?.logo || "./images/logos/generic-logo.png";
          document.getElementById("vehicle-logo").src = logoUrl;
          document.getElementById("vehicle-logo").alt = `Logo de $(
            element?.name || "genérico"
          )`;
        };

        // Llamar a fetchMarcasFromInfoauto al seleccionar un año
        document
          .getElementById("anio-options")
          .addEventListener("click", (event) => {
            if (event.target.classList.contains("custom-option")) {
              const year = event.target.textContent;
              fetchMarcasFromInfoauto(year);
            }
          });

        // Actualizar el logo al seleccionar una marca
        document
          .getElementById("marca-options")
          .addEventListener("click", (event) => {
            if (event.target.classList.contains("custom-option")) {
              const marcaId = event.target.dataset.value;
              getLogo(marcaId);
            }
          });
      });

      // Definir la función toggleCustomOptions en el ámbito global
      function toggleCustomOptions(id) {
        console.log(`toggleCustomOptions llamada con id: ${id}`);
        const options = document.getElementById(id);
        const placeholder = document.querySelector(
          `[onclick="toggleCustomOptions('${id}')"]`
        );

        if (!options || !placeholder) {
          console.error(
            `Error: No se encontró el elemento con ID "${id}" o su placeholder.`
          );
          return;
        }

        console.log("Elemento options:", options);
        console.log("Elemento placeholder:", placeholder);

        // Alternar el estado del select actual
        const isHidden = options.classList.contains("hidden");
        console.log(`Estado inicial de options.hidden: ${isHidden}`);

        document.querySelectorAll(".custom-options").forEach((opt) => {
          if (opt !== options) {
            opt.classList.add("hidden");
            setTimeout(() => opt.classList.add("display-none"), 300); // Retrasar el display: none
            console.log("Cerrando otro select:", opt);
          }
        });

        document
          .querySelectorAll(".custom-options-placeholder")
          .forEach((ph) => {
            if (ph !== placeholder) {
              ph.classList.remove("active"); // Quitar rotación de flecha
              console.log("Desactivando otro placeholder:", ph);
            }
          });

        if (isHidden) {
          options.classList.remove("display-none"); // Mostrar antes de la transición
          setTimeout(() => {
            options.classList.remove("hidden");
            placeholder.classList.add("active"); // Rotar la flecha del placeholder
            console.log("Abriendo select actual.");
          }, 10); // Pequeño retraso para permitir la transición
        } else {
          options.classList.add("hidden");
          placeholder.classList.remove("active"); // Quitar rotación de flecha
          setTimeout(() => options.classList.add("display-none"), 300); // Retrasar el display: none
          console.log("Cerrando select actual.");
        }

        // Verificar estilos aplicados
        const computedStyles = window.getComputedStyle(options);
        console.log("Estilos aplicados a options:", {
          display: computedStyles.display,
          opacity: computedStyles.opacity,
          visibility: computedStyles.visibility,
          transform: computedStyles.transform,
        });
      }

      window.toggleCustomOptions = toggleCustomOptions;

      // Cerrar las opciones si se hace clic fuera del contenedor
      document.addEventListener("click", (event) => {
        console.log("Click detectado fuera de los selects.");
        document
          .querySelectorAll(".custom-options-container")
          .forEach((container) => {
            if (!container.contains(event.target)) {
              const options = container.querySelector(".custom-options");
              const placeholder = container.querySelector(
                ".custom-options-placeholder"
              );
              options.classList.add("hidden");
              placeholder.classList.remove("active"); // Quitar rotación de flecha
              console.log(
                "Cerrando select por clic fuera del contenedor:",
                container
              );
            }
          });
      });

      function selectCustomOption(value, id, extraData = null) {
        console.log(
          `selectCustomOption llamada con valor: ${value}, id: ${id}, extraData: ${extraData}`
        );
        const options = document.getElementById(id);
        const placeholder = document.querySelector(
          `[onclick="toggleCustomOptions('${id}')"]`
        );

        if (!options || !placeholder) {
          console.error(
            `Error: No se encontró el elemento con ID "${id}" o su placeholder.`
          );
          return;
        }

        // Actualizar el texto del placeholder con el valor seleccionado
        placeholder.textContent = value;
        placeholder.dataset.value = extraData || value;

        // Cerrar el menú desplegable
        options.classList.add("hidden");
        setTimeout(() => options.classList.add("display-none"), 300); // Retrasar el display: none
        placeholder.classList.remove("active"); // Quitar rotación de flecha

        console.log(`Opción seleccionada: ${value}`);

        // Si se selecciona una marca, cargar los modelos
        if (id === "marca-options") {
          const year = document.querySelector(
            "[onclick=\"toggleCustomOptions('anio-options')\"]"
          ).dataset.value;
          fetchModelosFromInfoauto(extraData, year);
        }
      }

      window.selectCustomOption = selectCustomOption;

      document.addEventListener("DOMContentLoaded", () => {
        document
          .querySelectorAll(".custom-options-container")
          .forEach((container, index, containers) => {
            const placeholder = container.querySelector(
              ".custom-options-placeholder"
            );
            const options = container.querySelector(".custom-options");
            const searchContainer = options.querySelector(
              ".custom-search-container"
            );
            const searchInput = searchContainer
              ? searchContainer.querySelector("input")
              : null;

            console.log(`Inicializando select en contenedor ${index}`);

            // Función para reiniciar y mostrar el buscador
            const resetSearch = () => {
              if (searchContainer) {
                console.log(`Reiniciando buscador en contenedor ${index}`);
                searchContainer.classList.add("active");
                searchInput.value = ""; // Limpiar el texto del buscador
                const allOptions = options.querySelectorAll(".custom-option");
                allOptions.forEach((option) => {
                  option.style.display = "flex"; // Mostrar todas las opciones
                });
              }
            };

            // Abrir o cerrar las opciones al hacer clic en el placeholder
            placeholder.addEventListener("click", (event) => {
              event.stopPropagation();
              console.log(`Placeholder clickeado en contenedor ${index}`);
              const allOptions = document.querySelectorAll(".custom-options");
              const allPlaceholders = document.querySelectorAll(
                ".custom-options-placeholder"
              );

              // Cerrar todos los selects abiertos excepto el actual
              allOptions.forEach((opt, optIndex) => {
                if (opt !== options) {
                  console.log(`Cerrando select en contenedor ${optIndex}`);
                  opt.classList.add("hidden");
                }
              });

              allPlaceholders.forEach((ph, phIndex) => {
                if (ph !== placeholder) {
                  console.log(
                    `Desactivando placeholder en contenedor ${phIndex}`
                  );
                  ph.classList.remove("active");
                }
              });

              // Alternar el estado del select actual
              if (options.classList.contains("hidden")) {
                console.log(`Abriendo select en contenedor ${index}`);
                options.classList.remove("hidden");
                placeholder.classList.add("active");
                resetSearch(); // Reiniciar y mostrar el buscador
              } else {
                console.log(`Cerrando select en contenedor ${index}`);
                options.classList.add("hidden");
                placeholder.classList.remove("active");
              }
            });

            // Evitar que el buscador cierre el select al hacer clic
            if (searchContainer) {
              searchContainer.addEventListener("click", (event) => {
                event.stopPropagation(); // Evitar que el evento cierre el select
                console.log(`Buscador clickeado en contenedor ${index}`);
              });

              // Filtrar opciones en tiempo real
              searchInput.addEventListener("input", (event) => {
                const filterText = event.target.value.toLowerCase();
                console.log(
                  `Filtrando opciones en contenedor ${index} con texto: ${filterText}`
                );
                const allOptions = options.querySelectorAll(".custom-option");
                allOptions.forEach((option) => {
                  const optionText = option.textContent.toLowerCase();
                  option.style.display = optionText.includes(filterText)
                    ? "flex"
                    : "none";
                });
              });
            }

            // Seleccionar una opción
            options.addEventListener("click", (event) => {
              if (event.target.classList.contains("custom-option")) {
                console.log(
                  `Opción seleccionada en contenedor ${index}: ${event.target.textContent}`
                );
                placeholder.textContent = event.target.textContent;
                placeholder.dataset.value = event.target.textContent;
                options.classList.add("hidden");
                placeholder.classList.remove("active");
              }
            });

            // Cerrar las opciones si se hace clic fuera del contenedor
            document.addEventListener("click", (event) => {
              document
                .querySelectorAll(".custom-options-container")
                .forEach((container, containerIndex) => {
                  const options = container.querySelector(".custom-options");
                  const placeholder = container.querySelector(
                    ".custom-options-placeholder"
                  );
                  const searchContainer = options.querySelector(
                    ".custom-search-container"
                  );
                  if (!container.contains(event.target)) {
                    console.log(
                      `Cerrando select por clic fuera en contenedor ${containerIndex}`
                    );
                    options.classList.add("hidden");
                    placeholder.classList.remove("active");
                    if (searchContainer) {
                      searchContainer.classList.remove("active");
                    }
                  }
                });
            });
          });
      });

      document.addEventListener("DOMContentLoaded", () => {
        const updateVehicleSummary = () => {
          console.log("Actualizando resumen del vehículo...");

          const yearPlaceholder = document.querySelector(
            `[onclick="toggleCustomOptions('anio-options')"]`
          );
          const brandPlaceholder = document.querySelector(
            `[onclick="toggleCustomOptions('marca-options')"]`
          );
          const modelPlaceholder = document.querySelector(
            `[onclick="toggleCustomOptions('modelo-options')"]`
          );

          if (!yearPlaceholder || !brandPlaceholder || !modelPlaceholder) {
            console.error("No se encontraron los placeholders de los selects.");
            return;
          }

          const year =
            yearPlaceholder.dataset.value?.trim() ||
            yearPlaceholder.textContent.trim();
          const brand =
            brandPlaceholder.dataset.value?.trim() ||
            brandPlaceholder.textContent.trim();
          const model =
            modelPlaceholder.dataset.value?.trim() ||
            modelPlaceholder.textContent.trim();

          console.log("Datos seleccionados:", { year, brand, model });

          // Actualizar los elementos del paso 3
          document.getElementById("vehicle-brand").textContent =
            brand || "Marca";
          document.getElementById("vehicle-model").textContent =
            model || "Modelo";
          document.getElementById("vehicle-year").textContent = year || "Año";
        };

        // Actualizar los datos al avanzar al paso 3
        document
          .querySelector('.next-button[onclick="goToStep(3)"]')
          .addEventListener("click", () => {
            console.log(
              "Botón 'Siguiente' clickeado. Actualizando datos del paso 3..."
            );
            updateVehicleSummary();
          });
      });

      document.addEventListener("DOMContentLoaded", () => {
        const financeInput = document.querySelector(".net-finance-input");

        financeInput.addEventListener("input", (event) => {
          let value = event.target.value.replace(/[^0-9,]/g, ""); // Permitir solo números y comas
          value = value.replace(/,/g, "."); // Reemplazar comas por puntos
          const parts = value.split(".");
          parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, "."); // Agregar puntos como separadores de miles
          event.target.value = parts.join(",");
        });

        financeInput.addEventListener("blur", (event) => {
          if (event.target.value.endsWith(",")) {
            event.target.value = event.target.value.slice(0, -1); // Eliminar coma final si existe
          }
        });
      });
    </script>
    <script>
      async function fetchModelosFromInfoauto(marcaId, year) {
        try {
          const requestBody = {
            idMarca: marcaId,
            year: year.trim(),
            accessToken: null,
            action: "getModelsByBrand",
          };

          const response = await fetch("php/curl.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestBody),
          });

          if (!response.ok) {
            throw new Error(
              `Error al obtener modelos: ${response.status} ${response.statusText}`
            );
          }

          const data = await response.json();
          const modelosSelect = document.getElementById("modelo-options");

          // Guardar el buscador existente antes de limpiar el contenedor
          let searchContainer = modelosSelect.querySelector(".custom-search-container");
          if (!searchContainer) {
            searchContainer = document.createElement("div");
            searchContainer.className = "custom-search-container active";
            searchContainer.innerHTML = `
          <img src="./images/icons/lupita.svg" alt="Buscar" />
          <input type="text" placeholder="Buscar modelo..." oninput="filterOptions('modelo-options', this.value)" />
        `;
            modelosSelect.prepend(searchContainer);
          }

          modelosSelect.innerHTML = ""; // Limpiar opciones existentes
          // Reinsertar el buscador existente
          if (searchContainer) {
            modelosSelect.appendChild(searchContainer);
            searchContainer.classList.remove("hidden"); // Asegurar que esté visible
          }

          // Agregar los modelos obtenidos
          data.models.forEach((model) => {
            const option = document.createElement("div");
            option.className = "custom-option";
            option.textContent = model.modelo;
            option.dataset.value = model.codia;
            option.onclick = () =>
              selectCustomOption(model.modelo, "modelo-options", model.codia);
            modelosSelect.appendChild(option);
          });

          console.log("Modelos obtenidos:", data.models);
        } catch (error) {
          console.error("Error al obtener modelos desde Infoauto:", error);
        }
      }
    </script>
  </body>
</html>
